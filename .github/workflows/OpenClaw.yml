name: OpenClaw Automated Onboarding

on:
  workflow_dispatch:
    inputs:
      encrypted_tokens:
        description: 'Encrypted Qwen tokens (base64-encoded AES-256-CBC from Strix/Qwen.yml)'
        required: true
        type: string
      decryption_password:
        description: 'Password to decrypt the tokens'
        required: true
        type: string
      discord_bot_token:
        description: 'Discord bot token for channel configuration'
        required: true
        type: string

jobs:
  onboard-and-run:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ──────────────────────────────────────────────
      # 0. Mask sensitive inputs so they don't leak in logs
      # ──────────────────────────────────────────────

      - name: Mask secrets
        run: |
          echo "::add-mask::${{ github.event.inputs.encrypted_tokens }}"
          echo "::add-mask::${{ github.event.inputs.decryption_password }}"
          echo "::add-mask::${{ github.event.inputs.discord_bot_token }}"

      # ──────────────────────────────────────────────
      # 1. Setup runtimes
      # ──────────────────────────────────────────────

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: false

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      # ──────────────────────────────────────────────
      # 2. Install OpenClaw
      # ──────────────────────────────────────────────

      - name: Install OpenClaw
        run: |
          set -euo pipefail
          echo "::group::Installing OpenClaw"
          npm install -g openclaw@latest
          echo "OpenClaw version: $(openclaw --version)"
          echo "::endgroup::"

      - name: Fix OpenClaw extension permissions
        run: |
          set -euo pipefail
          echo "::group::Fixing extension permissions"

          # npm global installs on GitHub Actions have 777 permissions on the
          # extensions directory. OpenClaw's gateway blocks "world-writable"
          # plugin paths for security reasons. Fix by removing the world-writable bit.
          OPENCLAW_DIR=$(npm root -g)/openclaw
          if [ -d "$OPENCLAW_DIR/extensions" ]; then
            echo "Fixing permissions on $OPENCLAW_DIR/extensions"
            chmod -R o-w "$OPENCLAW_DIR/extensions"
            echo "Permissions fixed. Sample:"
            ls -la "$OPENCLAW_DIR/extensions/" | head -10
          else
            echo "::warning::OpenClaw extensions directory not found at $OPENCLAW_DIR/extensions"
          fi

          echo "::endgroup::"

      # ──────────────────────────────────────────────
      # 3. Build & install CLIProxyAPI from source
      # ──────────────────────────────────────────────

      - name: Install CLIProxyAPI from source
        run: |
          set -euo pipefail
          echo "::group::Building CLIProxyAPI"
          git clone --depth 1 https://github.com/router-for-me/CLIProxyAPI.git /tmp/CLIProxyAPI
          cd /tmp/CLIProxyAPI
          go build -o cli-proxy-api ./cmd/server
          sudo mv cli-proxy-api /usr/local/bin/cliproxyapi
          cd /
          rm -rf /tmp/CLIProxyAPI
          echo "CLIProxyAPI installed:"
          cliproxyapi --help || true
          echo "::endgroup::"

      # ──────────────────────────────────────────────
      # 4. Decrypt tokens and set up CLIProxyAPI
      # ──────────────────────────────────────────────

      - name: Decrypt Qwen tokens
        env:
          ENCRYPTED_TOKENS: ${{ github.event.inputs.encrypted_tokens }}
          DECRYPTION_PASSWORD: ${{ github.event.inputs.decryption_password }}
        run: |
          set -euo pipefail
          echo "::group::Decrypting Qwen tokens"

          AUTH_DIR="$HOME/.cli-proxy-api"
          mkdir -p "$AUTH_DIR"
          chmod 700 "$AUTH_DIR"

          TEMP_DIR=$(mktemp -d)
          cd "$TEMP_DIR"

          # Decode base64
          echo "$ENCRYPTED_TOKENS" | base64 -d > qwen-tokens.enc

          # Decrypt with AES-256-CBC (same scheme as Strix/Qwen.yml)
          openssl enc -aes-256-cbc -d -salt -pbkdf2 \
            -in qwen-tokens.enc \
            -out qwen-tokens.tar.gz \
            -pass pass:"$DECRYPTION_PASSWORD"

          # Extract token files into auth directory
          tar -xzf qwen-tokens.tar.gz -C "$AUTH_DIR"

          TOKEN_COUNT=$(find "$AUTH_DIR" -maxdepth 1 -name 'qwen-*.json' 2>/dev/null | wc -l)
          echo "Decrypted $TOKEN_COUNT Qwen token file(s)"

          if [ "$TOKEN_COUNT" -eq 0 ]; then
            echo "::error::No Qwen token files found after decryption!"
            echo "Verify the encrypted_tokens input and decryption_password are correct."
            rm -rf "$TEMP_DIR"
            exit 1
          fi

          echo "Token files found: $TOKEN_COUNT"

          # Cleanup temp files
          rm -rf "$TEMP_DIR"

          echo "AUTH_DIR=$AUTH_DIR" >> "$GITHUB_ENV"
          echo "::endgroup::"

      - name: Create CLIProxyAPI config
        run: |
          set -euo pipefail
          echo "::group::Creating CLIProxyAPI config"

          cat > "$AUTH_DIR/config.yaml" <<EOF
          port: 8317
          host: "127.0.0.1"
          auth-dir: "$AUTH_DIR"
          debug: true
          logging-to-file: false
          api-keys:
            - "dummykey"
          routing:
            strategy: "round-robin"
          request-retry: 3
          EOF

          # Fix indentation (remove leading whitespace from heredoc)
          sed -i 's/^          //' "$AUTH_DIR/config.yaml"

          echo "CLIProxyAPI config created"
          cat "$AUTH_DIR/config.yaml"
          echo "::endgroup::"

      - name: Start CLIProxyAPI
        run: |
          set -euo pipefail
          echo "::group::Starting CLIProxyAPI"

          # Start CLIProxyAPI in background with logs going to a file AND stdout
          nohup cliproxyapi -config "$AUTH_DIR/config.yaml" > /tmp/cliproxyapi.log 2>&1 &
          PROXY_PID=$!
          echo "CLIProxyAPI started (PID: $PROXY_PID)"
          echo "PROXY_PID=$PROXY_PID" >> "$GITHUB_ENV"

          # Wait for the proxy to be ready (use auth header since api-keys are configured)
          echo "Waiting for CLIProxyAPI to be ready..."
          READY=false
          for i in $(seq 1 60); do
            # Check if process is still alive
            if ! kill -0 $PROXY_PID 2>/dev/null; then
              echo "::error::CLIProxyAPI process died unexpectedly"
              cat /tmp/cliproxyapi.log || true
              exit 1
            fi

            # Try health check with auth header
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              -H "Authorization: Bearer dummykey" \
              http://127.0.0.1:8317/v1/models 2>/dev/null || echo "000")

            if [ "$HTTP_CODE" = "200" ]; then
              echo "CLIProxyAPI is ready! (HTTP $HTTP_CODE)"
              READY=true
              break
            fi

            echo "  Attempt $i/60: HTTP $HTTP_CODE - waiting..."
            sleep 2
          done

          if [ "$READY" = "false" ]; then
            echo "::warning::CLIProxyAPI didn't return 200 within 120 seconds"
            echo "Last CLIProxyAPI logs:"
            tail -30 /tmp/cliproxyapi.log || true
            echo ""
            echo "Continuing anyway (onboarding uses --custom-compatibility openai to skip probing)"
          fi

          # Show available models
          echo ""
          echo "Available models:"
          curl -s -H "Authorization: Bearer dummykey" \
            http://127.0.0.1:8317/v1/models 2>/dev/null | jq '.data[].id' 2>/dev/null || echo "(could not list models)"

          echo "::endgroup::"

      # ──────────────────────────────────────────────
      # 5. Run OpenClaw non-interactive onboarding
      # ──────────────────────────────────────────────

      - name: Run OpenClaw onboarding (non-interactive)
        run: |
          set -euo pipefail
          echo "::group::Running OpenClaw onboarding"

          openclaw onboard --non-interactive --accept-risk \
            --flow quickstart \
            --auth-choice custom-api-key \
            --custom-base-url "http://127.0.0.1:8317/v1" \
            --custom-api-key "dummykey" \
            --custom-model-id "qwen3-coder-plus" \
            --custom-compatibility openai \
            --skip-channels \
            --skip-skills \
            --skip-health \
            --skip-ui

          echo "Non-interactive onboarding completed"
          echo "::endgroup::"

      # ──────────────────────────────────────────────
      # 6. Patch config for Discord, Skills, Hooks
      # ──────────────────────────────────────────────

      - name: Patch OpenClaw config for Discord
        env:
          DISCORD_BOT_TOKEN: ${{ github.event.inputs.discord_bot_token }}
        run: |
          set -euo pipefail
          echo "::group::Patching OpenClaw config for Discord"

          CONFIG_FILE="$HOME/.openclaw/openclaw.json"

          if [ ! -f "$CONFIG_FILE" ]; then
            echo "::error::OpenClaw config file not found at $CONFIG_FILE"
            echo "Non-interactive onboarding may have failed."
            exit 1
          fi

          # Patch Discord configuration
          jq --arg token "$DISCORD_BOT_TOKEN" '
            .channels = (.channels // {}) |
            .channels.discord = {
              "enabled": true,
              "token": $token,
              "groupPolicy": "open",
              "guilds": {}
            }
          ' "$CONFIG_FILE" > "${CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"

          echo "Discord configuration patched successfully"
          echo "::endgroup::"

      - name: Patch OpenClaw config for Skills and Hooks
        run: |
          set -euo pipefail
          echo "::group::Patching Skills and Hooks"

          CONFIG_FILE="$HOME/.openclaw/openclaw.json"

          # Patch skills + hooks in one go
          jq '
            .skills = (.skills // {}) |
            .skills.install = { "nodeManager": "npm" } |
            .skills.entries = (.skills.entries // {}) |
            .hooks = (.hooks // {}) |
            .hooks.internal = { "enabled": false, "entries": {} }
          ' "$CONFIG_FILE" > "${CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"

          echo "Skills and Hooks configuration patched"
          echo "::endgroup::"

      - name: Install clawhub skill
        run: |
          set -euo pipefail
          echo "::group::Installing clawhub skill"

          mkdir -p "$HOME/.openclaw/workspace"

          # Install clawhub - the main skill dependency
          openclaw skills install clawhub || {
            echo "::warning::clawhub skill install failed - continuing without it"
          }

          echo "::endgroup::"

      # ──────────────────────────────────────────────
      # 7. Verify final configuration
      # ──────────────────────────────────────────────

      - name: Verify final configuration
        run: |
          set -euo pipefail
          echo "::group::Final configuration"

          CONFIG_FILE="$HOME/.openclaw/openclaw.json"

          echo "=== Final OpenClaw Config (redacted) ==="
          jq '
            if .channels?.discord?.token then
              .channels.discord.token = "***REDACTED***"
            else . end |
            if .models?.providers then
              .models.providers |= with_entries(
                if .value.apiKey then
                  .value.apiKey = "***REDACTED***"
                else . end
              )
            else . end |
            if .gateway?.auth?.token then
              .gateway.auth.token = "***REDACTED***"
            else . end
          ' "$CONFIG_FILE"

          echo ""
          echo "=== CLIProxyAPI Status ==="
          if kill -0 $PROXY_PID 2>/dev/null; then
            echo "CLIProxyAPI is running (PID: $PROXY_PID)"
            TOKEN_COUNT=$(find "$AUTH_DIR" -maxdepth 1 -name 'qwen-*.json' 2>/dev/null | wc -l)
            echo "Qwen tokens loaded: $TOKEN_COUNT"
          else
            echo "::error::CLIProxyAPI is NOT running!"
            cat /tmp/cliproxyapi.log || true
            exit 1
          fi

          echo ""
          echo "=== Configuration Summary ==="
          echo "LLM Provider: Custom (CLIProxyAPI -> Qwen)"
          echo "Model: qwen3-coder-plus"
          echo "API Base: http://127.0.0.1:8317/v1"
          echo "Channel: Discord (Open access)"

          echo "::endgroup::"

      - name: Show summary
        run: |
          cat << 'EOF' >> $GITHUB_STEP_SUMMARY
          ## OpenClaw Running

          ### Configuration
          | Setting | Value |
          |---------|-------|
          | LLM Provider | Custom (CLIProxyAPI -> Qwen) |
          | Model | `qwen3-coder-plus` |
          | API Endpoint | `http://127.0.0.1:8317/v1` |
          | Routing | Round-robin across all Qwen tokens |
          | Channel | Discord (Open access - all channels) |
          | Gateway | Local (port 18789, loopback, token auth) |
          | Timeout | 6 hours |

          ### Status
          The OpenClaw gateway is running with Discord connected.
          The bot should be online and responding to messages.
          The workflow will keep running for up to 6 hours or until manually cancelled.
          EOF

      # ──────────────────────────────────────────────
      # 8. Start OpenClaw gateway and keep alive
      # ──────────────────────────────────────────────

      - name: Start OpenClaw gateway and run indefinitely
        env:
          DISCORD_BOT_TOKEN: ${{ github.event.inputs.discord_bot_token }}
        run: |
          set -euo pipefail

          echo "============================================"
          echo "  Starting OpenClaw Gateway + Discord Bot"
          echo "============================================"
          echo ""

          # Verify CLIProxyAPI is still running
          if ! kill -0 $PROXY_PID 2>/dev/null; then
            echo "::error::CLIProxyAPI died before gateway start!"
            cat /tmp/cliproxyapi.log || true
            exit 1
          fi
          echo "CLIProxyAPI is alive (PID: $PROXY_PID)"

          # Start the OpenClaw gateway directly (systemd doesn't work well in GitHub Actions)
          # The gateway connects to Discord, handles messages, and proxies to CLIProxyAPI
          echo "Starting OpenClaw gateway..."
          nohup openclaw gateway > /tmp/openclaw-gateway.log 2>&1 &
          GATEWAY_PID=$!
          echo "Gateway started (PID: $GATEWAY_PID)"

          # Give the gateway time to initialize and connect to Discord
          echo "Waiting for gateway to initialize..."
          sleep 15

          # Check if gateway is still running
          if ! kill -0 $GATEWAY_PID 2>/dev/null; then
            echo "::error::Gateway process died during startup!"
            echo "=== Gateway logs ==="
            cat /tmp/openclaw-gateway.log || true
            echo "=== CLIProxyAPI logs ==="
            cat /tmp/cliproxyapi.log || true
            exit 1
          fi

          echo ""
          echo "Gateway is running!"
          echo ""

          # Show initial gateway logs
          echo "=== Initial Gateway Logs ==="
          cat /tmp/openclaw-gateway.log || true
          echo "=== End Initial Logs ==="
          echo ""

          # Check gateway health
          openclaw health --timeout 10000 2>/dev/null && echo "Health check: PASSED" || echo "Health check: gateway may still be initializing"

          echo ""
          echo "============================================"
          echo "  OpenClaw is LIVE! Discord bot is online."
          echo "  The workflow will keep running for ~6 hours."
          echo "  Cancel this workflow to stop the bot."
          echo "============================================"
          echo ""

          # Keep-alive loop: monitor processes and print status every 5 minutes
          ITERATION=0
          while true; do
            ITERATION=$((ITERATION + 1))

            # Check if CLIProxyAPI is alive
            if ! kill -0 $PROXY_PID 2>/dev/null; then
              echo ""
              echo "$(date -u '+%Y-%m-%d %H:%M:%S UTC') [ERROR] CLIProxyAPI (PID: $PROXY_PID) died!"
              echo "=== CLIProxyAPI logs ==="
              tail -50 /tmp/cliproxyapi.log || true

              # Try to restart CLIProxyAPI
              echo "Attempting to restart CLIProxyAPI..."
              nohup cliproxyapi -config "$AUTH_DIR/config.yaml" > /tmp/cliproxyapi.log 2>&1 &
              PROXY_PID=$!
              echo "CLIProxyAPI restarted (PID: $PROXY_PID)"
              sleep 5
            fi

            # Check if gateway is alive
            if ! kill -0 $GATEWAY_PID 2>/dev/null; then
              echo ""
              echo "$(date -u '+%Y-%m-%d %H:%M:%S UTC') [ERROR] Gateway (PID: $GATEWAY_PID) died!"
              echo "=== Gateway logs ==="
              tail -50 /tmp/openclaw-gateway.log || true

              # Try to restart gateway
              echo "Attempting to restart gateway..."
              nohup openclaw gateway > /tmp/openclaw-gateway.log 2>&1 &
              GATEWAY_PID=$!
              echo "Gateway restarted (PID: $GATEWAY_PID)"
              sleep 10
            fi

            # Print status every 5 minutes (every 10 iterations of 30s sleep)
            if [ $((ITERATION % 10)) -eq 0 ]; then
              UPTIME_MIN=$((ITERATION * 30 / 60))
              echo ""
              echo "$(date -u '+%Y-%m-%d %H:%M:%S UTC') [STATUS] Uptime: ~${UPTIME_MIN}m | CLIProxyAPI PID: $PROXY_PID | Gateway PID: $GATEWAY_PID"

              # Print last few lines of logs
              echo "--- Recent gateway logs ---"
              tail -5 /tmp/openclaw-gateway.log 2>/dev/null || true
              echo "--- Recent CLIProxyAPI logs ---"
              tail -5 /tmp/cliproxyapi.log 2>/dev/null || true
              echo "---"
            fi

            sleep 30
          done
